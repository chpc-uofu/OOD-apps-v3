Notchpeak Node Status
===============

Based on Arizona State University's [Sol status page][sol-sol-status].

Scrapes SLURM via `sinfo` and plots node status with `plotly`.

On `notchrm.chpc.utah.edu`, the user `hpcapps` runs the generating shell
and python scripts via `crontab`:

    * * * * * /uufs/chpc.utah.edu/sys/ondemand/chpc-apps/chpc-notchpeak-status/bin/get-np-node-status.sh &> /uufs/chpc.utah.edu/sys/ondemand/chpc-apps/chpc-notchpeak-status/crontab.diag

Note that because cron runs on an empty environment, we supply full paths
to the SLURM commands. Also, since the script is run as `hpcapps`, the directories
where it writes needs to be writeable by `hpcapps`.

Shell script will only save every tenth `zstd -19` compressed comma-separated
value (csv) files (every ten minutes). This is determined by an incremented
counter that is stored in `snapshot/.snapshot_modulo.do.not.delete`. When there
are errors the `zstd` file will not be generated and csvs will not be
removed. This is to help determine what occurred in the data and catch
all edge cases.

The final html page is made available to the OOD nodes 
symbolically linking the html file:

    /uufs/chpc.utah.edu/sys/ondemand/chpc-apps/chpc-notchpeak-status/np.html
        -> /var/www/ood/public

The main change to the status application was to include the status html
page as an iframe (with an associated legend).

OOD Installation
---------

1. Git clone this repository
2. Modify titles and node status html location in `app.rb`, `manifest.yml`, `views/layout.erb`
3. Run setup to verify app install

    ```bash
    scl enable ondemand -- bin/setup
    ```

4. If error, install gem dependencies in app directory

    ```bash
    scl enable ondemand -- bin/bundle install --path vendor/bundle
    ```

Debugging
---------

Diagnose issues from diagnostics file generated by cron:

    /packages/public/sol-node-status/crontab.diag

and from Python runtime:

    /packages/public/sol-node-status/crontab.diag.log

Note: `crontab.diag` is non-empty upon successful execution with normal
diagnostic statistics on the plotly figure, i.e., 

    len :: total number of nodes being visualized
      M :: number of nodes in figure's horizontal direction
      N :: number of nodes in figure's vertical direction
      w :: figure width in pixels
      h :: figure height in pixels

Ideas for further improvements
---------

- separate general, general-gpu and owner partitions
- color change based on the CPU/memory load of the node

[sol-status]: https://github.com/jyalim/sol-status-page
[sol-repo]: https://github.com/asu-ke/sol
[sol-status]: https://links.asu.edu/sol-status
[example]: https://math.la.asu.edu/~yalim/sol-status-demo.html
